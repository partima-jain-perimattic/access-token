# main.py
from fastapi import FastAPI, Request
from fastapi.responses import RedirectResponse, HTMLResponse
import httpx
import os
from urllib.parse import urlencode

app = FastAPI()

# Replace with your real values
APP_ID = os.getenv("FB_APP_ID", "YOUR_APP_ID")
APP_SECRET = os.getenv("FB_APP_SECRET", "YOUR_APP_SECRET")
REDIRECT_URI = os.getenv("FB_REDIRECT_URI", "http://localhost:8000/auth/callback")
SCOPES = "instagram_basic,pages_show_list"

@app.get("/", response_class=HTMLResponse)
async def home():
    auth_url = f"https://www.facebook.com/v23.0/dialog/oauth?" + urlencode({
        "client_id": APP_ID,
        "redirect_uri": REDIRECT_URI,
        "scope": SCOPES,
        "response_type": "code"
    })
    return f"""
    <html>
    <body>
        <h2>Instagram Login Demo</h2>
        <a href='{auth_url}'>Login with Instagram</a>
    </body>
    </html>
    """

@app.get("/auth/callback")
async def auth_callback(code: str):
    # Step 1: Exchange code for access token
    async with httpx.AsyncClient() as client:
        token_res = await client.get("https://graph.facebook.com/v23.0/oauth/access_token", params={
            "client_id": APP_ID,
            "redirect_uri": REDIRECT_URI,
            "client_secret": APP_SECRET,
            "code": code
        })
        token_data = token_res.json()
        access_token = token_data.get("access_token")

        if not access_token:
            return {"error": "Failed to retrieve access token", "details": token_data}

        # Step 2: Get user's Pages
        pages_res = await client.get("https://graph.facebook.com/v23.0/me/accounts", params={
            "access_token": access_token
        })
        pages = pages_res.json().get("data", [])

        if not pages:
            return {"error": "No pages found", "details": pages_res.json()}

        # Step 3: Get Instagram Business Account ID from Page
        page_id = pages[0]['id']
        ig_res = await client.get(f"https://graph.facebook.com/v23.0/{page_id}", params={
            "fields": "instagram_business_account",
            "access_token": access_token
        })
        ig_account = ig_res.json().get("instagram_business_account", {})

        if not ig_account:
            return {"error": "No Instagram account connected to page", "details": ig_res.json()}

        ig_id = ig_account['id']

        # Step 4: Fetch Instagram Media
        media_res = await client.get(f"https://graph.facebook.com/v23.0/{ig_id}/media", params={
            "access_token": access_token
        })
        media = media_res.json().get("data", [])

        return {
            "access_token": access_token,
            "page_id": page_id,
            "instagram_id": ig_id,
            "media": media
        }
